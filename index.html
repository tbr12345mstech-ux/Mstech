<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€</title>
<style>
  :root{--bg:#0e1116;--panel:#151a21;--primary:#21e0b4;--muted:#91a0b2;--text:#e9eef6;}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial,sans-serif}
  .wrap{max-width:900px;margin:20px auto;padding:16px}
  h1{font-size:28px;margin:8px 0 20px}
  .badge{display:inline-block;background:#233041;color:#cfe3ff;border:1px solid #2f4057;border-radius:12px;padding:4px 10px;margin-right:8px;font-size:12px}
  .panel{background:var(--panel);border:1px solid #242b36;border-radius:14px;padding:14px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;cursor:pointer;border:0;border-radius:12px;background:var(--primary);color:#062c24;
       padding:12px 16px;font-weight:700;font-size:16px}
  .btn.secondary{background:#243041;color:#e6f0ff;border:1px solid #384a63}
  .btn.small{padding:8px 12px;font-size:14px;font-weight:600}
  .grid{display:grid;gap:12px}
  @media(min-width:860px){ .grid.two{grid-template-columns:1fr 1fr} }
  .videoBox,.imageBox{background:black;border-radius:12px;overflow:hidden;border:1px solid #2b3442;position:relative}
  video,canvas,img{display:block;width:100%;height:auto}
  .hint{color:var(--muted);font-size:13px;margin-top:6px}
  input[type="text"]{width:100%;background:#0f1420;border:1px solid #2a3340;border-radius:10px;padding:12px;color:#eaf2ff;font-size:16px}
  textarea{width:100%;min-height:110px;background:#0f1420;border:1px solid #2a3340;border-radius:10px;padding:12px;color:#eaf2ff;font-size:15px}
  .keyrow{display:grid;grid-template-columns:150px 1fr;gap:12px;align-items:center}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #33465f;color:#b7c6da;background:#121927;font-size:12px}
  .footer{margin-top:20px;color:#93a6bd;font-size:12px}
  .toggle{display:flex;gap:8px;align-items:center}
  .toggle input{transform:scale(1.2)}
</style>
</head>
<body>
<div class="wrap">
  <h1>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€ <span class="badge">ZXing í•˜ì´ë¸Œë¦¬ë“œ</span><span class="badge">PWA ì—†ì´ ë‹¨ì¼íŒŒì¼</span></h1>

  <div class="panel">
    <div class="row">
      <button id="startBtn" class="btn">ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
      <button id="stopBtn" class="btn secondary">ì •ì§€</button>
      <div class="toggle">
        <label class="pill"><input id="enhanceChk" type="checkbox"> ë°˜ì‚¬í‘œë©´ ë³´ì •(ë…¸ì´ì¦ˆâ†“ ëŒ€ë¹„â†‘)</label>
      </div>
    </div>
    <div class="grid two">
      <div class="videoBox">
        <video id="video" playsinline muted></video>
      </div>
      <div class="panel">
        <div class="keyrow"><div class="pill">ë°”ì½”ë“œ</div><input id="barcodeOut" type="text" placeholder="ìë™ ì…ë ¥â€¦"></div>
        <div class="keyrow"><div class="pill">ì˜ˆìƒ ìƒ‰ìƒ</div><input id="colorOut" type="text" placeholder="ìë™ ê°ì§€â€¦"></div>
        <div class="keyrow"><div class="pill">ëª¨ë¸/í‚¤ì›Œë“œ</div><input id="keywordOut" type="text" placeholder="ë¡œê³ +ë¬¸ì OCR í›„ë³´â€¦"></div>
        <div class="row" style="margin-top:10px"><button id="copyBtn" class="btn small secondary">ë³µì‚¬</button></div>
        <div class="hint">íŒ: ë°”ì½”ë“œë¥¼ í™”ë©´ <b>ê°€ë¡œë°©í–¥</b>ìœ¼ë¡œ ë‘ê³  20~25cm ê±°ë¦¬ì—ì„œ 1ì´ˆê°„ ê³ ì •í•˜ì„¸ìš”.</div>
      </div>
    </div>
    <div class="hint" id="status">ëŒ€ê¸° ì¤‘â€¦</div>
  </div>

  <div class="panel">
    <div class="row"><label class="btn secondary"><input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none">ğŸ“„ ì‚¬ì§„ì—ì„œ ì¸ì‹(ì—…ë¡œë“œ/ì´¬ì˜)</label></div>
    <div class="grid two" style="margin-top:12px">
      <div class="imageBox"><img id="preview" alt="" /></div>
      <div>
        <div class="keyrow"><div class="pill">íŒŒì¼ ë°”ì½”ë“œ</div><input id="fBarcode" type="text" placeholder="ìë™ ì…ë ¥â€¦"></div>
        <div class="keyrow"><div class="pill">íŒŒì¼ ìƒ‰ìƒ</div><input id="fColor" type="text" placeholder="ìë™ ê°ì§€â€¦"></div>
        <div class="keyrow"><div class="pill">íŒŒì¼ í‚¤ì›Œë“œ</div><input id="fKeyword" type="text" placeholder="ë¡œê³ +ë¬¸ì OCR í›„ë³´â€¦"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3 style="margin-top:0">íŒë§¤ ê¸€ ìƒì„±</h3>
    <textarea id="postOut" placeholder="ìë™ ìƒì„±ëœ íŒë§¤ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    <div class="row" style="margin-top:8px">
      <button id="genPost" class="btn">ë²ˆê°œì¥í„° íŒë§¤ê¸€ ìƒì„±</button>
      <button id="genEbay" class="btn secondary">eBay Title ìë™ ìƒì„±</button>
    </div>
  </div>

  <div class="footer">â“˜ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. HTTPS(https://)ì—ì„œ ë™ì‘í•˜ì„¸ìš”. ì¸ì‹ì—”ì§„: ZXing BrowserMultiFormatReader + ì´ë¯¸ì§€ ì „ì²˜ë¦¬ + ë‹¨ìˆœ OCR.</div>
</div>

<!-- ZXing (ë°”ì½”ë“œ) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<!-- TinyColor (ìƒ‰ìƒ) -->
<script src="https://cdn.jsdelivr.net/npm/tinycolor2@1.6.0/dist/tinycolor-min.js"></script>
<!-- Tesseract (ê°„ë‹¨ OCR; ìš©ëŸ‰â†‘ë¼ì„œ CDN lazy load) -->
<script>
  const $ = s=>document.querySelector(s);
  const video = $("#video");
  const startBtn=$("#startBtn"), stopBtn=$("#stopBtn"), statusEl=$("#status");
  const barcodeOut=$("#barcodeOut"), colorOut=$("#colorOut"), keywordOut=$("#keywordOut");
  const fileInput=$("#fileInput"), preview=$("#preview");
  const fBarcode=$("#fBarcode"), fColor=$("#fColor"), fKeyword=$("#fKeyword");
  const copyBtn=$("#copyBtn"), genPost=$("#genPost"), genEbay=$("#genEbay");
  const enhanceChk=$("#enhanceChk");

  let codeReader, stream, running=false, ocrLoaded=false;

  async function ensureOCR(){
    if(ocrLoaded) return;
    await new Promise((res,rej)=>{
      const sc=document.createElement('script');
      sc.src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js";
      sc.onload=()=>res(); sc.onerror=rej; document.body.appendChild(sc);
    });
    ocrLoaded=true;
  }

  function msg(t){ statusEl.textContent=t; }

  function estimateColorFromFrame(canvas){
    const ctx=canvas.getContext("2d");
    const {data,width,height}=ctx.getImageData(0,0,canvas.width,canvas.height);
    let r=0,g=0,b=0,c=0;
    for(let i=0;i<data.length;i+=40){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; }
    r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
    const name=tinycolor({r,g,b}).toName() || tinycolor({r,g,b}).toHexString();
    return name;
  }

  function enhanceCanvasFromVideo(v){
    const c=document.createElement('canvas'); const ctx=c.getContext('2d');
    const w=v.videoWidth, h=v.videoHeight; c.width=w; c.height=h;
    ctx.drawImage(v,0,0,w,h);
    if(enhanceChk.checked){
      // ê°€ìš°ì‹œì•ˆ ìœ ì‚¬ ë¸”ëŸ¬ + ëŒ€ë¹„ ì¦ê°€
      ctx.filter='contrast(130%) brightness(110%)';
      ctx.drawImage(c,0,0);
    }
    return c;
  }

  async function startCamera(){
    try{
      codeReader = new ZXingBrowser.BrowserMultiFormatReader();
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"environment", focusMode:"continuous" }, audio:false
      });
      video.srcObject=stream; await video.play();
      running=true; msg("ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘â€¦ ë°”ì½”ë“œë¥¼ ê°€ë¡œë¡œ ë§ì¶”ì„¸ìš”.");
      scanLoop();
    }catch(e){
      msg("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: "+e.message);
    }
  }

  async function scanLoop(){
    if(!running) return;
    try{
      const canvas=enhanceCanvasFromVideo(video);
      // 1) í”„ë ˆì„ ë°”ë¡œ ë””ì½”ë“œ (ZXing)
      const luminance = ZXingBrowser.HTMLCanvasElementLuminanceSourceFactory.createLuminanceSource(canvas);
      const binarizer = new ZXingBrowser.GlobalHistogramBinarizer(luminance);
      const binaryBitmap = new ZXingBrowser.BinaryBitmap(binarizer);
      const result = ZXingBrowser.ZXingModuleWrapper.decodeBitmap(binaryBitmap, {
        tryHarder:true, formatsHint:[
          ZXingBrowser.BarcodeFormat.EAN_13,
          ZXingBrowser.BarcodeFormat.EAN_8,
          ZXingBrowser.BarcodeFormat.UPC_A,
          ZXingBrowser.BarcodeFormat.CODE_128
        ]
      });
      if(result && result.text){
        barcodeOut.value = result.text;
        msg("ë°”ì½”ë“œ ê°ì§€: "+result.text);
      }
      // 2) ìƒ‰ìƒ ëŒ€ëµ ì¶”ì •
      colorOut.value = estimateColorFromFrame(canvas);
      // 3) OCR í‚¤ì›Œë“œ (í”„ë ˆì„ì—ì„œ 1ì´ˆë§ˆë‹¤ í•œ ë²ˆ ì •ë„)
      if(!keywordOut.value){
        await ensureOCR();
        const { data } = await Tesseract.recognize(canvas, 'eng+kor', { tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_/&+.' });
        const text=(data.text||'').replace(/\s+/g,' ').trim();
        if(text) keywordOut.value = text.slice(0,80);
      }
    }catch(e){
      // ë””ì½”ë“œ ì‹¤íŒ¨ëŠ” í”í•¨ â†’ ì¡°ìš©íˆ ë¬´ì‹œ
    }finally{
      setTimeout(scanLoop, 250); // 4fps ì •ë„
    }
  }

  function stopCamera(){
    running=false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    msg("ì •ì§€");
  }

  // ì´ë¯¸ì§€ íŒŒì¼ì—ì„œ ì¸ì‹
  async function analyzeImage(file){
    const url=URL.createObjectURL(file);
    preview.src=url;
    await new Promise(r=>preview.onload=r);
    // 1) ë°”ì½”ë“œ
    try{
      const reader=new ZXingBrowser.BrowserMultiFormatReader();
      const result = await reader.decodeFromImage(preview);
      if(result && result.text){ fBarcode.value=result.text; }
    }catch{}
    // 2) ìƒ‰ìƒ
    const c=document.createElement('canvas'); const ctx=c.getContext('2d');
    c.width=preview.naturalWidth; c.height=preview.naturalHeight; ctx.drawImage(preview,0,0);
    fColor.value = estimateColorFromFrame(c);
    // 3) OCR
    await ensureOCR();
    const {data} = await Tesseract.recognize(preview,'eng+kor');
    const text=(data.text||'').replace(/\s+/g,' ').trim();
    if(text) fKeyword.value = text.slice(0,100);
  }

  function buildPost(titleHint, code, color, kw){
    const title = titleHint || (kw? kw.split(' ').slice(0,8).join(' ') : 'ìƒí’ˆ');
    return `ì œëª©: ${title}
ìƒíƒœ: ì¤‘ê³  Â· ì •ìƒ ì‘ë™
ìƒ‰ìƒ(ëŒ€ëµ): ${color||'-'}
ë°”ì½”ë“œ: ${code||'-'}
êµ¬ì„±í’ˆ: ë³¸í’ˆ
ê±°ë˜: ì§ê±°ë˜/íƒë°°
ë©”ëª¨: ì‚¬ì§„ ì°¸ê³  ë°”ëë‹ˆë‹¤. ë¹ ë¥¸ íŒë§¤ ì›í•©ë‹ˆë‹¤.`;
  }

  // ì´ë²¤íŠ¸
  startBtn.onclick=startCamera;
  stopBtn.onclick=stopCamera;
  copyBtn.onclick=()=>{ navigator.clipboard.writeText(barcodeOut.value||''); msg('ë³µì‚¬ë¨'); };
  fileInput.onchange=e=>{ const f=e.target.files?.[0]; if(f) analyzeImage(f); };
  genPost.onclick=()=>{
    const post=buildPost(keywordOut.value, barcodeOut.value, colorOut.value, keywordOut.value);
    $("#postOut").value=post;
  };
  genEbay.onclick=()=>{
    const base = (keywordOut.value||'').replace(/\s+/g,' ').trim() || 'Used Item';
    const bc = barcodeOut.value? ` | Barcode:${barcodeOut.value}` : '';
    const title = (base+' '+bc).slice(0,80);
    alert('eBay Title:\n'+title);
  };

  // UX: í˜ì´ì§€ ì§„ì… ì‹œ HTTPS ì²´í¬
  if(location.protocol!=='https:'){
    msg('HTTPS í™˜ê²½ ê¶Œì¥ (ì¹´ë©”ë¼ ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥)');
  }else{
    msg('ëŒ€ê¸° ì¤‘â€¦ ì¹´ë©”ë¼ í—ˆìš© í›„ ìŠ¤ìº”í•˜ì„¸ìš”.');
  }
</script>
</body>
</html>
