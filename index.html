<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>판매 자동화 2.5 — 회전 자동보정 + 사진/카메라</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
:root{--bg:#0d1117;--panel:#0f172a;--muted:#9ca3af;--text:#e5e7eb;--mint:#22d3ee}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
header{padding:14px 16px;border-bottom:1px solid #1f2937}
h1{margin:0 0 6px;font-size:22px}
small{color:#9ca3af}
main{max-width:960px;margin:0 auto;padding:14px}
.tabs{display:flex;gap:8px;margin:10px 0}
.tab{padding:10px 14px;border-radius:12px;border:1px solid #24304d;background:#0b1220;color:#e5e7eb;cursor:pointer}
.tab.active{background:linear-gradient(90deg,#2563eb,#22d3ee);color:#fff}
.panel{display:none;background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:12px}
.panel.active{display:block}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{padding:10px 12px;border-radius:12px;border:1px solid #24304d;background:#0b1220;color:#e5e7eb;cursor:pointer}
button.primary{background:linear-gradient(90deg,#2563eb,#22d3ee);color:#fff;border-color:#22d3ee}
video, img{width:100%;max-width:520px;border-radius:12px;border:3px solid #22d3ee;background:#000}
.status{margin-top:8px;color:#9ca3af;font-size:13px}
input[type=text]{border-radius:12px;border:1px solid #24304d;background:#0b1220;color:#e5e7eb;padding:10px 12px;font-size:16px;flex:1;min-width:260px}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;background:#0ea5e9;color:#fff;font-size:12px;margin-left:6px}
.hidden{display:none}
canvas{display:none}
</style>
</head>
<body>
<header>
  <h1>판매 자동화 2.5 <span class="badge">회전 자동보정 + ZXing</span></h1>
  <small>사진은 0/90/180/270° + 리샘플/대비강화로 여러 번 시도 · 카메라 스캔도 지원</small>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="photo">사진으로 인식</div>
    <div class="tab" data-tab="camera">카메라로 인식</div>
  </div>

  <!-- Photo panel -->
  <section class="panel active" id="photo">
    <div class="row">
      <input id="file" type="file" accept="image/*" capture="environment">
      <input id="out1" type="text" placeholder="결과(자동 입력)…">
      <button id="copy1">복사</button>
    </div>
    <img id="preview" alt="preview" class="hidden"/>
    <div id="pstatus" class="status">팁: 바코드가 사진의 70~90% 차지하도록 가까이 찍어주세요.</div>
    <canvas id="work"></canvas>
  </section>

  <!-- Camera panel -->
  <section class="panel" id="camera">
    <div class="row">
      <button id="start" class="primary">카메라 스캔 시작</button>
      <button id="stop">정지</button>
      <button id="flip">회전</button>
      <input id="out2" type="text" placeholder="결과(자동 입력)…">
      <button id="copy2">복사</button>
    </div>
    <video id="video" playsinline muted></video>
    <div id="cstatus" class="status">바코드를 가로로 맞추고 1초 정지.</div>
  </section>
</main>

<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
// Tabs
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(a=>a.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  t.classList.add('active');
  document.getElementById(t.dataset.tab).classList.add('active');
}));

const sleep = ms => new Promise(r=>setTimeout(r,ms));
async function copyText(id, statusEl){
  const v = document.getElementById(id).value || '';
  try{ await navigator.clipboard.writeText(v); statusEl.textContent='복사됨 ✅'; }catch(e){ statusEl.textContent='복사 실패'; }
}

// Photo decode with rotation & enhancement
const file = document.getElementById('file');
const preview = document.getElementById('preview');
const work = document.getElementById('work');
const pstatus = document.getElementById('pstatus');
const out1 = document.getElementById('out1');
document.getElementById('copy1').onclick=()=>copyText('out1', pstatus);

const reader = new ZXingBrowser.BrowserBarcodeReader();

file.addEventListener('change', async () => {
  const f = file.files[0]; if(!f) return;
  out1.value='';
  preview.classList.remove('hidden');
  preview.src = URL.createObjectURL(f);
  await new Promise(r=>preview.onload=r);

  pstatus.textContent='분석 중… (회전/리샘플/대비강화 시도)';
  const rotations = [0, 90, 180, 270];
  const scales = [1.0, 0.75, 0.5];
  for (const rot of rotations){
    for (const sc of scales){
      for (const enhance of [false, true]){
        const res = await tryDecode(preview, rot, sc, enhance);
        if (res){
          out1.value = res; pstatus.textContent='감지됨: '+res; beep(); return;
        }
        await sleep(15);
      }
    }
  }
  pstatus.textContent='❌ 바코드를 찾지 못했습니다. 더 가까이/선명하게 찍어서 다시 시도하세요.';
});

async function tryDecode(img, rot=0, sc=1, enhance=false){
  const w = Math.max(64, Math.floor(img.naturalWidth*sc));
  const h = Math.max(64, Math.floor(img.naturalHeight*sc));
  const cw = (rot%180===0)? w : h;
  const ch = (rot%180===0)? h : w;
  work.width = cw; work.height = ch;
  const ctx = work.getContext('2d');
  ctx.save();
  ctx.translate(cw/2, ch/2);
  ctx.rotate(rot*Math.PI/180);
  ctx.drawImage(img, -w/2, -h/2, w, h);
  ctx.restore();
  if (enhance){
    const imageData = ctx.getImageData(0,0,cw,ch);
    const data = imageData.data;
    const c = 1.25, m = 128;
    for(let i=0;i<data.length;i+=4){
      data[i] = Math.max(0, Math.min(255, (data[i]-m)*c + m));
      data[i+1] = Math.max(0, Math.min(255, (data[i+1]-m)*c + m));
      data[i+2] = Math.max(0, Math.min(255, (data[i+2]-m)*c + m));
    }
    ctx.putImageData(imageData,0,0);
  }
  const url = work.toDataURL("image/png");
  try{
    const r = await reader.decodeFromImageUrl(url);
    return r.getText();
  }catch(e){ return null; }
}

// Camera decode
const video = document.getElementById('video');
const cstatus = document.getElementById('cstatus');
const out2 = document.getElementById('out2');
document.getElementById('copy2').onclick=()=>copyText('out2', cstatus);
let controls=null, cstream=null, mreader=null, useFront=false;

async function startCam(){
  if(controls) return;
  cstatus.textContent='카메라 여는 중…';
  const facing = useFront ? 'user' : 'environment';
  try{
    cstream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:facing}}, audio:false});
  }catch(e){
    cstream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:facing}}, audio:false});
  }
  video.srcObject = cstream; await video.play();
  mreader = new ZXingBrowser.BrowserMultiFormatReader();
  controls = await mreader.decodeFromVideoElement(video, (result, err)=>{
    if(result && result.getText()){
      const txt = result.getText();
      if(out2.value!==txt){ out2.value=txt; cstatus.textContent='감지됨: '+txt; beep(); }
    }
  });
  cstatus.textContent='인식 준비 완료. 가로 방향으로 1초 정지.';
}
function stopCam(){
  if(controls){ try{controls.stop()}catch{} controls=null; }
  if(mreader){ try{mreader.reset()}catch{} mreader=null; }
  if(cstream){ cstream.getTracks().forEach(t=>t.stop()); cstream=null; }
  cstatus.textContent='정지됨';
}
document.getElementById('start').onclick=startCam;
document.getElementById('stop').onclick=stopCam;
document.getElementById('flip').onclick=()=>{ useFront=!useFront; stopCam(); startCam(); };

// tiny beep
const ac = new (window.AudioContext||window.webkitAudioContext)();
function beep(){
  const o=ac.createOscillator(), g=ac.createGain();
  o.connect(g); g.connect(ac.destination); o.frequency.value=880; g.gain.value=0.001; o.start();
  g.gain.exponentialRampToValueAtTime(0.4, ac.currentTime+0.02);
  setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+0.08); o.stop(ac.currentTime+0.1); }, 80);
}
</script>
</body>
</html>
