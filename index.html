<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€ (Full)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0B132B">
  <style>
    :root{--bg:#0b132b;--panel:#1c2541;--muted:#3a506b;--accent:#13d8c3;--text:#e8f1ff;}
    *{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    .wrap{max-width:940px;margin:0 auto;padding:20px;}
    h1{font-size:28px;margin:8px 0 16px}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:#22304f;color:#b3c2db;font-size:12px;margin-left:6px}
    .card{background:var(--panel);border:1px solid #253155;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.8rem 1rem;border-radius:12px;border:0;background:var(--accent);color:#042f2e;font-weight:700;cursor:pointer}
    .btn.secondary{background:#233456;color:#e8f1ff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    input, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #334266;background:#0f1a32;color:#e8f1ff}
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:#9fb0c6;margin-top:6px}
    video, canvas, img{width:100%;border-radius:12px;background:#000}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .copy{margin-left:8px}
    footer{opacity:.7;font-size:12px;margin:20px 0}
    .pill{font-size:12px;background:#12203b;border:1px solid #2b3f61;border-radius:999px;padding:.3rem .6rem}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€ <span class="badge">OCR + ë°”ì½”ë“œ + eBay/ë²ˆê°œì¥í„°</span> <span class="badge">ì˜¤í”„ë¼ì¸ PWA</span></h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <button id="startCam" class="btn">ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
          <button id="stopCam" class="btn secondary">ì •ì§€</button>
          <div class="hint">íŒ: ë°”ì½”ë“œë¥¼ í™”ë©´ ì¤‘ì•™ì— ë‘ê³  20~30cm ê±°ë¦¬ì—ì„œ 1ì´ˆê°„ ê³ ì •</div>
          <video id="video" playsinline muted></video>
        </div>
        <div class="col">
          <label>ë°”ì½”ë“œ</label>
          <div class="row">
            <input id="barcodeOut" placeholder="ìë™ ì…ë ¥â€¦" />
            <button class="btn secondary copy" data-copy="barcodeOut">ë³µì‚¬</button>
          </div>
          <div class="hint" id="scanStatus">ëŒ€ê¸° ì¤‘â€¦</div>
          <div class="grid">
            <label>ì‚¬ì§„ ì—…ë¡œë“œ/ì´¬ì˜(ë°”ì½”ë“œ+ë¬¸ì ì¸ì‹)</label>
            <input type="file" id="file" accept="image/*" capture="environment">
            <img id="preview" alt="" />
            <canvas id="canvas" hidden></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ì¸ì‹ ê²°ê³¼</h3>
      <div class="row">
        <div class="col">
          <label>ì˜ˆìƒ ìƒ‰ìƒ</label>
          <input id="colorOut" placeholder="ìë™ ê°ì§€â€¦" />
        </div>
        <div class="col">
          <label>ëª¨ë¸/í‚¤ì›Œë“œ í›„ë³´ (OCR ì¶”ì¶œ)</label>
          <textarea id="candidates" placeholder="ë¡œê³ /ë¬¸ì OCR í›„ë³´â€¦"></textarea>
        </div>
      </div>
      <div class="stack" style="margin-top:8px">
        <span class="pill">ì‹¤ì‹œê°„ ë°”ì½”ë“œ: ZXing</span>
        <span class="pill">OCR: Tesseract.js (ko+eng)</span>
      </div>
    </div>

    <div class="card">
      <h3>íŒë§¤ ê¸€ ìƒì„±</h3>
      <div class="row">
        <div class="col">
          <label>ë²ˆê°œì¥í„° ì œëª©</label>
          <input id="krTitle">
          <label>ë²ˆê°œì¥í„° ë³¸ë¬¸</label>
          <textarea id="krBody"></textarea>
          <div class="row">
            <button class="btn" id="genKR">ë²ˆê°œì¥í„° ê¸€ ìƒì„±</button>
            <button class="btn secondary copy" data-copy="krTitle">ì œëª© ë³µì‚¬</button>
            <button class="btn secondary copy" data-copy="krBody">ë³¸ë¬¸ ë³µì‚¬</button>
          </div>
        </div>
        <div class="col">
          <label>eBay Title</label>
          <input id="enTitle">
          <label>eBay Description</label>
          <textarea id="enDesc"></textarea>
          <div class="row">
            <button class="btn" id="genEN">eBay í…ìŠ¤íŠ¸ ìƒì„±</button>
            <button class="btn secondary copy" data-copy="enTitle">Title ë³µì‚¬</button>
            <button class="btn secondary copy" data-copy="enDesc">Desc ë³µì‚¬</button>
          </div>
        </div>
      </div>
      <div class="hint">ì œëª©/ë³¸ë¬¸ì€ ë°”ì½”ë“œ + OCR í‚¤ì›Œë“œë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤. ì ì ˆíˆ ìˆ˜ë™ ë³´ì •í•˜ì„¸ìš”.</div>
    </div>

    <footer>â“’ MSTECH. ì´ í˜ì´ì§€ëŠ” ì˜¤í”„ë¼ì¸ì—ì„œë„ ë™ì‘í•©ë‹ˆë‹¤. ìµœì´ˆ ì ‘ì† í›„ í™ˆ í™”ë©´ì— ì¶”ê°€í•´ ì‚¬ìš©í•˜ì„¸ìš”.</footer>
  </div>

  <!-- libs via CDN -->
  <script src="https://unpkg.com/@zxing/library@0.21.2"></script>
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

  <script>
  // PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js');
    });
  }

  const video = document.getElementById('video');
  const startBtn = document.getElementById('startCam');
  const stopBtn = document.getElementById('stopCam');
  const statusEl = document.getElementById('scanStatus');
  const barcodeOut = document.getElementById('barcodeOut');
  const fileInput = document.getElementById('file');
  const preview = document.getElementById('preview');
  const canvas = document.getElementById('canvas');
  const colorOut = document.getElementById('colorOut');
  const candidates = document.getElementById('candidates');

  let stream = null;
  let reader = null;
  let scanning = false;
  let rafId = null;

  function avgColorFromCanvas(ctx, w, h){
    const d = ctx.getImageData(0,0,w,h).data;
    let r=0,g=0,b=0,count=0;
    for(let i=0;i<d.length;i+=4){ r+=d[i]; g+=d[i+1]; b+=d[i+2]; count++; }
    r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
    // naive label
    const max = Math.max(r,g,b);
    let name = 'Unknown';
    if(max===r && r>140 && g<120 && b<120) name='Red';
    else if(max===g && g>140) name='Green';
    else if(max===b && b>140) name='Blue';
    else if(r>200&&g>200&&b>200) name='White';
    else if(r<70&&g<70&&b<70) name='Black';
    else if(r>180 && g>150 && b<100) name='Yellow/Gold';
    colorOut.value = name;
    return {r,g,b};
  }

  async function scanLoop(){
    if(!scanning || !video.videoWidth) { rafId = requestAnimationFrame(scanLoop); return; }
    const codeReader = reader;
    try{
      const result = await codeReader.decodeOnceFromVideoElement(video);
      if(result && result.text){
        barcodeOut.value = result.text;
        statusEl.textContent = 'ë°”ì½”ë“œ ì¸ì‹ ì„±ê³µ';
        // stop after success but leave preview on
        scanning = false;
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      }
    }catch(e){
      // keep trying
    }finally{
      rafId = requestAnimationFrame(scanLoop);
    }
  }

  async function startCamera(){
    try{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
      video.srcObject = stream;
      await video.play();
      // estimate color from live frame
      const ctx = canvas.getContext('2d');
      const tick = ()=>{
        if(!scanning) return;
        const w = video.videoWidth, h = video.videoHeight;
        if(w && h){
          canvas.width = w; canvas.height = h;
          ctx.drawImage(video,0,0,w,h);
          avgColorFromCanvas(ctx,w,h);
        }
        requestAnimationFrame(tick);
      };
      scanning = true;
      if(!reader) reader = new ZXing.BrowserMultiFormatReader();
      statusEl.textContent = 'ìŠ¤ìº” ì¤‘â€¦ ë°”ì½”ë“œë¥¼ ì¤‘ì•™ì— ë‘ì„¸ìš”';
      scanLoop();
      tick();
    }catch(err){
      alert('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.\nì„¤ì • > Safari > ì¹´ë©”ë¼ > í—ˆìš©');
      statusEl.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”';
    }
  }

  function stopCamera(){
    scanning = false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    if(rafId) cancelAnimationFrame(rafId);
    statusEl.textContent = 'ì •ì§€';
  }

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);

  // Upload & OCR
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    preview.src = url;

    // draw to canvas
    await new Promise(r=>{ preview.onload=r; });
    const w = preview.naturalWidth, h = preview.naturalHeight;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(preview,0,0,w,h);
    avgColorFromCanvas(ctx,w,h);

    // Try barcode decode from still
    try{
      const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
      const binarizer = new ZXing.Common.HybridBinarizer(luminanceSource);
      const bitmap = new ZXing.BinaryBitmap(binarizer);
      const hints = new Map();
      const formats = [ ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E ];
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
      const res = new ZXing.MultiFormatReader().decode(bitmap, hints);
      if(res && res.text) barcodeOut.value = res.text;
    }catch(_) {}

    // OCR with ko+eng
    candidates.value = 'ì¸ì‹ ì¤‘â€¦';
    try{
      const worker = await Tesseract.createWorker('kor', 1);
      await worker.loadLanguage('eng');
      await worker.initialize('eng+kor');
      const { data: { text } } = await worker.recognize(canvas);
      await worker.terminate();
      const cleaned = text.replace(/[\s]+/g,' ').trim();
      candidates.value = cleaned || '(ì¸ì‹ ê²°ê³¼ ì—†ìŒ)';
    }catch(err){
      candidates.value = '(OCR ì˜¤ë¥˜)';
    }
  });

  // Copy helper
  document.querySelectorAll('.copy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-copy');
      const el = document.getElementById(id);
      el.select(); el.setSelectionRange(0,99999);
      document.execCommand('copy');
      btn.textContent = 'ë³µì‚¬ë¨';
      setTimeout(()=>btn.textContent='ë³µì‚¬',1200);
    });
  });

  // Listing generators
  function pickKeywords(base, extra){
    const words = (base+' '+extra).toLowerCase().split(/[^a-z0-9ê°€-í£\.\-]+/).filter(v=>v && v.length>1);
    // unique and truncate
    const seen = new Set(); const out=[];
    for(const w of words){ if(!seen.has(w)){ seen.add(w); out.push(w); } if(out.length>16) break; }
    return out;
  }

  function krSentence(){
    const code = barcodeOut.value || '';
    const cand = candidates.value || '';
    const color = colorOut.value || 'ê¸°ë³¸';
    const kws = pickKeywords(cand, code).slice(0,10);
    const title = `${(kws[0]||'ë¯¸í™•ì¸ ì œí’ˆ')} / ${color} / ë°”ì½”ë“œ:${code||'ë¯¸í™•ì¸'}`;
    const body = [
      `â€¢ ìƒíƒœ: ì¤‘ê³  / ì‚¬ì§„ ì°¸ê³ `,
      `â€¢ ìƒ‰ìƒ: ${color}`,
      code ? `â€¢ ë°”ì½”ë“œ(EAN/UPC): ${code}` : null,
      kws.length? `â€¢ í‚¤ì›Œë“œ: ${kws.join(', ')}` : null,
      `â€”`,
      `ì§ê±°ë˜ ê°€ëŠ¥ Â· íƒë°° ê°€ëŠ¥ Â· ë¬¸ì˜ í™˜ì˜`
    ].filter(Boolean).join('\n');
    return {title, body};
  }

  function enSentence(){
    const code = barcodeOut.value || '';
    const cand = candidates.value || '';
    const color = colorOut.value || 'Default';
    const kws = pickKeywords(cand, code).slice(0,12);
    const title = `${(kws[0]||'Unknown Item')} ${color} ${code?('EAN/UPC '+code):''}`.trim();
    const desc = [
      `Condition: Used (see photos)`,
      `Color: ${color}`,
      code ? `Barcode: ${code}` : null,
      kws.length? `Keywords: ${kws.join(', ')}` : null
    ].filter(Boolean).join('\n');
    return {title, desc};
  }

  document.getElementById('genKR').addEventListener('click', ()=>{
    const {title, body} = krSentence();
    document.getElementById('krTitle').value = title;
    document.getElementById('krBody').value = body;
  });
  document.getElementById('genEN').addEventListener('click', ()=>{
    const {title, desc} = enSentence();
    document.getElementById('enTitle').value = title;
    document.getElementById('enDesc').value = desc;
  });
  </script>
</body>
</html>
