<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€</title>
<meta name="theme-color" content="#0a0f14"/>
<style>
  :root{--bg:#0a0f14;--card:#111824;--muted:#89a;--accent:#1ee6c5;--text:#e9f1ff;}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,apple sd gothic neo,Pretendard,Segoe UI,Arial,sans-serif}
  .wrap{max-width:900px;margin:24px auto;padding:16px}
  h1{font-size:28px;margin:4px 0 16px;letter-spacing:.2px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:16px;padding:16px;border:1px solid #1c2533}
  .btn{background:var(--accent);color:#00302a;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#233142;color:#dbe9ff}
  .btn.ghost{background:#182231;color:#cfe4ff;border:1px solid #2a394f}
  .muted{color:var(--muted);font-size:13px}
  input,textarea{width:100%;background:#0f1622;color:#e9f1ff;border:1px solid #2a394f;border-radius:12px;padding:12px}
  textarea{min-height:110px;resize:vertical}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .pill{display:inline-block;background:#132033;border:1px solid #25354d;color:#cfe4ff;padding:6px 10px;border-radius:999px;font-size:12px}
  video,canvas,.preview{width:100%;border-radius:14px;background:#000;display:block}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€</h1>

  <div class="row">
    <div class="card" style="flex:1 1 520px">
      <div class="toolbar">
        <button id="btnStart" class="btn">ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
        <button id="btnStop" class="btn secondary">ì •ì§€</button>
        <span class="pill">OCR í´ë°± ON Â· ì˜¤í”„ë¼ì¸ ë™ì‘</span>
      </div>

      <video id="video" playsinline muted></video>
      <div class="muted" style="margin-top:8px">
        ë°”ì½”ë“œë¥¼ í™”ë©´ ì¤‘ì•™ ê°€ë¡œë°©í–¥ì— ë‘ê³  <b>20~30cm</b>ì—ì„œ <b>1ì´ˆ ê³ ì •</b>í•˜ì„¸ìš”.
      </div>

      <div class="grid two" style="margin-top:12px">
        <div>
          <label class="muted">ë°”ì½”ë“œ</label>
          <div class="row">
            <input id="barcode" placeholder="ìë™ ì…ë ¥â€¦" />
            <button id="btnCopyCode" class="btn ghost">ë³µì‚¬</button>
          </div>
        </div>
        <div>
          <label class="muted">ì˜ˆìƒ ìƒ‰ìƒ</label>
          <input id="color" value="ìë™ ê°ì§€â€¦" />
        </div>
      </div>
    </div>

    <div class="card" style="flex:1 1 320px">
      <div class="grid">
        <label class="muted">ì‚¬ì§„ ì—…ë¡œë“œ/ì´¬ì˜ (ë°”ì½”ë“œ+ë¬¸ì ì¸ì‹)</label>
        <input id="file" type="file" accept="image/*" capture="environment" />
        <canvas id="canvas" class="preview" hidden></canvas>
      </div>

      <div class="grid" style="margin-top:12px">
        <label class="muted">ì¸ì‹ ê²°ê³¼ Â· í‚¤ì›Œë“œ (OCR)</label>
        <textarea id="ocrBox" placeholder="ë¡œê³ /ë¬¸ì OCR í›„ë³´â€¦"></textarea>
        <span class="muted" id="engineNote">ì—”ì§„: ZXing(ì‹¤ì‹œê°„) + Tesseract.js(ko+eng)</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="grid two">
      <div>
        <label class="muted">íŒë§¤ ì œëª© (KR)</label>
        <input id="titleKr" placeholder="ìë™ ìƒì„± ì œëª©â€¦" />
      </div>
      <div>
        <label class="muted">eBay Title (EN)</label>
        <input id="titleEn" placeholder="Auto-generated eBay titleâ€¦" />
      </div>
      <div>
        <label class="muted">íŒë§¤ ë³¸ë¬¸ (KR)</label>
        <textarea id="descKr" placeholder="ìƒíƒœ/êµ¬ì„±/ë©”ëª¨ ë“±"></textarea>
      </div>
      <div>
        <label class="muted">Description (EN)</label>
        <textarea id="descEn" placeholder="Auto-generated brief descriptionâ€¦"></textarea>
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <button id="btnGen" class="btn">íŒë§¤ê¸€ ìë™ ìƒì„±</button>
      <button id="btnCopyAll" class="btn ghost">ë³µì‚¬(ë²ˆê°œì¥í„°)</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px">ìƒíƒœ: ëŒ€ê¸° ì¤‘â€¦</div>
  </div>

</div>

<!-- ZXing (barcode) + Tesseract (OCR) CDN -->
<script type="module">
import { BrowserMultiFormatReader, NotFoundException } from 'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/index.js';
import Tesseract from 'https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const file = document.getElementById('file');
const barcodeEl = document.getElementById('barcode');
const colorEl = document.getElementById('color');
const ocrBox = document.getElementById('ocrBox');
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnCopyCode = document.getElementById('btnCopyCode');
const btnGen = document.getElementById('btnGen');
const btnCopyAll = document.getElementById('btnCopyAll');
const titleKr = document.getElementById('titleKr');
const titleEn = document.getElementById('titleEn');
const descKr = document.getElementById('descKr');
const descEn = document.getElementById('descEn');

let stream = null, zxing = null, loopFlag = false;
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
const copy = (t)=> navigator.clipboard.writeText(t||'').then(()=>toast('ë³µì‚¬ ì™„ë£Œ âœ…')).catch(()=>toast('ë³µì‚¬ ì‹¤íŒ¨ âŒ'));
function toast(msg){ statusEl.textContent = msg; }

/* í‰ê· ìƒ‰ìƒ ì¶”ì • */
function averageColorFromVideo() {
  try{
    const w=160,h=120; canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,w,h);
    const {data}=ctx.getImageData(0,0,w,h);
    let r=0,g=0,b=0,c=0; for(let i=0;i<data.length;i+=4){ r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; }
    r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
    const max=Math.max(r,g,b); const color=(max===r?'Red':max===g?'Green':'Blue');
    return `${color} (${r},${g},${b})`;
  }catch{ return 'Unknown'; }
}

/* OCR */
async function runOCR(img) {
  try{
    const worker = await Tesseract.createWorker('kor+eng', 1);
    const { data:{ text } } = await worker.recognize(img);
    await worker.terminate();
    return text.replace(/\s+\n/g,'\n').trim();
  }catch{ return ''; }
}

/* í…ìŠ¤íŠ¸ ìƒì„± */
function generateTexts({code, colorGuess, ocrText}) {
  const brand = (ocrText.match(/coca[\s-]*cola|dell|samsung|apple|lg|seagate|western\s*digital|wd|nike|adidas|sony|panasonic|lenovo|hp|hynix|sandisk/i)||[''])[0];
  const cleanBrand = brand ? brand.replace(/\s+/g,' ').toUpperCase() : '';
  const keywords = (ocrText||'').replace(/[^\p{L}\p{N}\s\-\/]/gu,' ').split(/\s+/).filter(w=>w.length>2).slice(0,10).join(' ');
  const colorWord = (colorGuess||'Unknown').split(' ')[0];

  titleKr.value = [cleanBrand?`[${cleanBrand}]`:null, keywords||null, code?`(ë°”ì½”ë“œ:${code})`:null].filter(Boolean).join(' ').slice(0,80);
  titleEn.value = [(cleanBrand||'MSTECH'), keywords?` ${keywords}`:'', code?` [Barcode ${code}]`:''].join('').slice(0,80);

  descKr.value = [
    `â€¢ ì˜ˆìƒ ìƒ‰ìƒ: ${colorGuess||'Unknown'}`,
    code?`â€¢ ë°”ì½”ë“œ: ${code}`:null,
    `â€¢ í‚¤ì›Œë“œ: ${keywords||'N/A'}`,
    '', 'ìƒíƒœ: ì‚¬ì§„ ì°¸ê³  / ê¸°ë³¸ ì ê²€ ì™„ë£Œ', 'êµ¬ì„±í’ˆ: ë³¸í’ˆ ê¸°ì¤€', 'ê±°ë˜: ë²ˆê°œì¥í„°/ì§ê±°ë˜/íƒë°°'
  ].filter(Boolean).join('\n');

  descEn.value = [
    `â€¢ Est. color: ${colorWord}`,
    code?`â€¢ Barcode: ${code}`:null,
    `â€¢ Keywords: ${keywords||'N/A'}`,
    '', 'Condition: See photos. Basic check done.', 'Includes: Unit only', 'Shipping: Domestic/Intl'
  ].filter(Boolean).join('\n');
}

/* ë¼ì´ë¸Œ ìŠ¤ìº” */
async function startCamera() {
  try{
    if(stream) stopCamera();
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{exact:'environment'}, width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30,max:60} }, audio:false
    });
    video.srcObject = stream; await video.play();
    colorEl.value = averageColorFromVideo();
    toast('ì¹´ë©”ë¼ ì‹œì‘. ë°”ì½”ë“œë¥¼ ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”.');
    loopFlag = true; if(!zxing) zxing = new BrowserMultiFormatReader();
    scanLoop();
  }catch{ toast('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. (ì„¤ì • > ë¸Œë¼ìš°ì € > ì¹´ë©”ë¼)'); }
}

async function scanLoop(){
  while(loopFlag){
    try{
      const result = await zxing.decodeOnceFromVideoDevice(undefined, video);
      if(result?.getText){
        const code = result.getText(); barcodeEl.value = code;
        colorEl.value = averageColorFromVideo(); toast(`ë°”ì½”ë“œ ì¸ì‹ ì„±ê³µ: ${code} âœ…`);
        await sleep(600);
      }
    }catch(err){
      if(!(err instanceof NotFoundException)) await sleep(200);
    }
    if(!barcodeEl.value){ // OCR í´ë°±
      await sleep(1500);
      try{
        const w=640,h=360; canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,w,h);
        const text = await runOCR(canvas);
        if(text){
          const m = text.match(/\b\d{12,14}\b/);
          if(m && !barcodeEl.value){ barcodeEl.value = m[0]; toast(`OCR ë°”ì½”ë“œ í›„ë³´: ${m[0]}`); }
          ocrBox.value = text.slice(0,1500);
        }
      }catch{}
    }
  }
}

function stopCamera(){
  loopFlag = false;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(video.srcObject) video.srcObject=null;
}

/* ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¸ì‹ */
file.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f); const img = new Image();
  await new Promise(res=>{ img.onload=res; img.src=url; });
  const w=900,h=Math.round(img.height*(w/img.width));
  canvas.width=w; canvas.height=h; canvas.hidden=false;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);

  // ZXing ì‹œë„
  try{
    const { HTMLCanvasElementLuminanceSource } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/browser/HTMLCanvasElementLuminanceSource.js');
    const { HybridBinarizer } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/common/HybridBinarizer.js');
    const { BinaryBitmap } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/core/BinaryBitmap.js');
    const { MultiFormatReader } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/core/MultiFormatReader.js');
    const { DecodeHintType } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/core/DecodeHintType.js');
    const { BarcodeFormat } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/core/BarcodeFormat.js');

    const src = new HTMLCanvasElementLuminanceSource(canvas);
    const bin = new HybridBinarizer(src);
    const bmp = new BinaryBitmap(bin);
    const reader = new MultiFormatReader();
    reader.setHints(new Map([[DecodeHintType.POSSIBLE_FORMATS,[BarcodeFormat.EAN_13,BarcodeFormat.EAN_8,BarcodeFormat.CODE_128,BarcodeFormat.UPC_A]]]));
    const res = reader.decode(bmp);
    if(res?.getText){ barcodeEl.value = res.getText(); toast(`ì´ë¯¸ì§€ ë°”ì½”ë“œ: ${res.getText()}`); }
  }catch{}

  // OCR
  const text = await runOCR(canvas);
  ocrBox.value = text.slice(0,1500);
  const m = text.match(/\b\d{12,14}\b/);
  if(m && !barcodeEl.value){ barcodeEl.value = m[0]; toast(`OCR ë°”ì½”ë“œ í›„ë³´: ${m[0]}`); }
  colorEl.value = 'Unknown';
});

/* ë²„íŠ¼ */
btnStart.onclick = startCamera;
btnStop.onclick = ()=>{ stopCamera(); toast('ì •ì§€'); };
btnCopyCode.onclick = ()=>copy(barcodeEl.value||'');
btnGen.onclick = ()=>{
  generateTexts({ code: barcodeEl.value?.trim(), colorGuess: colorEl.value?.trim(), ocrText: ocrBox.value||'' });
  toast('íŒë§¤ ê¸€ ìë™ ìƒì„± ì™„ë£Œ âœ…');
};
btnCopyAll.onclick = ()=>{
  const block = [
    `ì œëª©: ${titleKr.value}`, '', descKr.value, '', `eBay Title: ${titleEn.value}`, descEn.value?`\n\n${descEn.value}`:''
  ].join('\n');
  copy(block);
};

window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
