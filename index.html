<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#0f1115; --card:#151923; --acc:#10d1c2; --txt:#e9eef5; --mut:#97a3b6; --line:#243042;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
body{margin:0;background:var(--bg);color:var(--txt)}
header{padding:20px 16px;font-weight:800;font-size:22px;letter-spacing:.2px}
.container{padding:16px;display:grid;gap:14px;max-width:980px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
h2{margin:0 0 10px 0;font-size:16px}
.row{display:grid;gap:10px}
label{font-size:13px;color:var(--mut)}
input,textarea,button,select{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
  background:#0f1320;color:var(--txt);outline:none;
}
textarea{min-height:110px;resize:vertical}
button{background:var(--acc);color:#002b27;border:none;font-weight:700}
button.secondary{background:#1a2233;color:var(--txt)}
.btnrow{display:grid;gap:10px;grid-template-columns:1fr 1fr}
video,canvas,.preview{
  width:100%;background:#000;border-radius:12px;display:block;aspect-ratio:16/9;object-fit:cover
}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;
  border:1px solid var(--line);background:#0e1523;color:var(--mut);font-size:12px}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px}
.copy{cursor:pointer}
.small{font-size:12px;color:var(--mut)}
.footer{padding:30px 16px;color:var(--mut);text-align:center}
</style>
<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<header>MSTECH ìƒí’ˆ ì¸ì‹ & íŒë§¤ê¸€</header>

<div class="container">

  <div class="card">
    <div class="btnrow">
      <button id="btnStart">ğŸ“· ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘</button>
      <button id="btnStop" class="secondary">ì •ì§€</button>
    </div>
    <div class="row" style="margin-top:10px">
      <video id="video" playsinline autoplay muted></video>
      <input id="file" type="file" accept="image/*" />
      <button id="btnSnap" class="secondary">ì‚¬ì§„ì—ì„œ ì¸ì‹(ì—…ë¡œë“œ/ì´¬ì˜)</button>
      <canvas id="canvas" class="preview" hidden></canvas>
      <div class="small">íŒ: ë°”ì½”ë“œëŠ” <b>ê°€ë¡œ ë°©í–¥</b>ìœ¼ë¡œ í”„ë ˆì„ ì¤‘ì•™ì— 1~2ì´ˆ ìœ ì§€</div>
    </div>
  </div>

  <div class="card">
    <h2>ì¸ì‹ ê²°ê³¼</h2>
    <div class="grid2">
      <div>
        <label>ë°”ì½”ë“œ</label>
        <input id="barcode" placeholder="ìë™ ì…ë ¥" />
      </div>
      <div>
        <label>ì˜ˆìƒ ìƒ‰ìƒ</label>
        <input id="color" placeholder="ìë™ ê°ì§€â€¦" />
      </div>
    </div>
    <div style="margin-top:10px">
      <label>ëª¨ë¸/í‚¤ì›Œë“œ í›„ë³´</label>
      <textarea id="candidates" placeholder="í›„ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    </div>
    <div class="btnrow" style="margin-top:10px">
      <button class="secondary" id="btnOCR">ë¼ë²¨/OCR ì¸ì‹</button>
      <button class="secondary" id="btnSuggest">ê°€ê²©Â·í‚¤ì›Œë“œ ìë™ë³´ì •</button>
    </div>
  </div>

  <div class="card">
    <h2>íŒë§¤ ê¸€ ìƒì„±</h2>
    <label>ë©”ëª¨/êµ¬ì„±í’ˆ/ìƒíƒœ</label>
    <textarea id="memo" placeholder="ì˜ˆ) ì‚¬ìš©ê° ë³´í†µ, ìƒí™œìŠ¤í¬ë˜ì¹˜ ìˆìŒ / í…ŒìŠ¤íŠ¸ ì •ìƒ"></textarea>

    <div class="btnrow" style="margin-top:10px">
      <button id="btnDanggeun">ë²ˆê°œì¥í„° íŒë§¤ê¸€ ìƒì„±</button>
      <button id="btnNaver">ë„¤ì´ë²„ ì¹´í˜/ì¤‘ê³ ë‚˜ë¼ ê¸€ ìƒì„±</button>
    </div>
    <div class="btnrow" style="margin-top:10px">
      <button id="btnEbay">eBay Title ìë™ ìƒì„±</button>
      <button class="secondary" id="btnCopyAll">ë³µì‚¬(ë²ˆê°œì¥í„°)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <label>KR ì œëª©</label>
      <input id="krTitle" class="copy" />
      <label>KR ë³¸ë¬¸</label>
      <textarea id="krBody" class="copy"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <label>EN Title</label>
      <input id="enTitle" class="copy" />
      <label>EN Desc</label>
      <textarea id="enDesc" class="copy"></textarea>
    </div>
    <div class="small">í•„ë“œ í´ë¦­ ì‹œ ì „ì²´ ì„ íƒ â†’ ë³µì‚¬í•˜ê¸° ì‰¬ì›€</div>
  </div>

  <div class="card">
    <h2>ë¹ ë¥¸ ì‹œì„¸(ì˜¤í”„ë¼ì¸ ê·¼ì‚¬)</h2>
    <div id="priceBox" class="kv">
      <div>Query</div><div id="q"></div>
      <div>ì¶”ì²œê°€(ë¹ ë¥´ê²Œ)</div><div id="p1"></div>
      <div>ì¶”ì²œê°€(ì œê°’)</div><div id="p2"></div>
    </div>
  </div>

  <div class="footer">Â© MSTECH | ì˜¤í”„ë¼ì¸ ì‘ë™(í…ŒìŠ¤íŠ¸ìš©) Â· ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”</div>
</div>

<script>
/* ---------- utils ---------- */
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

function setText(id,val){ const el=$(id); if(!el) return; el.value = val || ''; }
function appendCandidates(arr){ 
  const t=$("#candidates"); 
  const cur=(t.value||"").trim();
  const add=[...new Set(arr.map(s=>s.trim()).filter(Boolean))];
  t.value = (cur?cur+"\n":"") + add.join("\n");
}

function averageColorFromCanvas(canvas){
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  const {data,width,height}=ctx.getImageData(0,0,canvas.width,canvas.height);
  let r=0,g=0,b=0,count=0;
  for(let i=0;i<data.length;i+=4){
    // ë°ê¸° ë„ˆë¬´ ì–´ë‘ìš´ í”½ì…€ ì œì™¸
    if(data[i]+data[i+1]+data[i+2] < 40) continue;
    r+=data[i]; g+=data[i+1]; b+=data[i+2]; count++;
  }
  if(!count) return "Unknown";
  r=Math.round(r/count); g=Math.round(g/count); b=Math.round(b/count);
  // ê°„ë‹¨ ë§¤í•‘
  const map=[
    ["Black", [30,30,40]],["White",[220,220,220]],["Red",[200,60,60]],
    ["Orange",[230,140,60]],["Yellow",[240,220,60]],["Green",[60,160,80]],
    ["Blue",[70,120,210]],["Navy",[30,50,110]],["Purple",[130,80,160]],
    ["Pink",[240,140,180]],["Brown",[110,80,60]],["Gray/Silver",[170,175,180]]
  ];
  let best="Unknown", bestd=1e9;
  for(const [name,[R,G,B]] of map){
    const d=(r-R)**2+(g-G)**2+(b-B)**2;
    if(d<bestd){bestd=d;best=name;}
  }
  return best;
}

function buildQuery(){
  const bc=$("#barcode").value.trim();
  const cand=($("#candidates").value||"")
    .split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,5).join(" ");
  return (cand||bc||"").slice(0,120);
}

/* ---------- camera + barcode ----------- */
let cameraOn=false;

async function startCamera(){
  if(cameraOn) return;
  const video=$("#video");
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},
      audio:false
    });
    video.srcObject=stream;
    await video.play();
    cameraOn=true;

    // Quagga ì‹œì‘
    Quagga.init({
  inputStream: {
    name: "Live",
    type: "LiveStream",
    target: document.querySelector("#video"),
    constraints: {
      facingMode: "environment",
      width: { ideal: 1920 },
      height: { ideal: 1080 }
    }
  },
  locator: { patchSize: "large", halfSample: false },
  numOfWorkers: 0, // iPhone Safari ì„±ëŠ¥ ë³´ì™„
  frequency: 5,
  decoder: {
    readers: [
      "ean_reader",
      "ean_8_reader",
      "code_128_reader",
      "code_39_reader",
      "upc_reader",
      "upc_e_reader"
    ]
  }
}, err => {
  if (err) {
    console.error(err);
    alert("ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨");
    return;
  }
  Quagga.start();
});
Quagga.init({
      inputStream:{
        name:"Live", type:"LiveStream", target:video,
        constraints:{facingMode:"environment"}
      },
      locator:{patchSize:"medium",halfSample:true},
      numOfWorkers:navigator.hardwareConcurrency?Math.min(4,navigator.hardwareConcurrency):2,
      decoder:{readers:["ean_reader","ean_8_reader","code_128_reader","code_39_reader","upc_reader","upc_e_reader"]}
    },(err)=>{
      if(err){ console.error(err); alert("ë°”ì½”ë“œ ì—”ì§„ ì´ˆê¸°í™” ì‹¤íŒ¨"); return; }
      Quagga.start();
    });

    Quagga.onDetected(res=>{
      if(res?.codeResult?.code){
        $("#barcode").value = res.codeResult.code;
      }
    });

  }catch(e){
    alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨. iPhone: ì„¤ì • > Safari > ì¹´ë©”ë¼ í—ˆìš© ì²´í¬");
  }
}

function stopCamera(){
  try{
    Quagga.stop();
  }catch(e){}
  const v=$("#video");
  const s=v.srcObject;
  if(s) s.getTracks().forEach(t=>t.stop());
  v.srcObject=null; cameraOn=false;
}

/* ---------- image upload / OCR / color ----------- */
async function drawFromFile(file){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=$("#canvas");
      const maxW=1280; const scale=Math.min(1,maxW/img.width);
      canvas.width=img.width*scale; canvas.height=img.height*scale;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      canvas.hidden=false;
      resolve(canvas);
    };
    img.onerror=reject;
    img.src=URL.createObjectURL(file);
  });
}

async function runOCR(canvas){
  const {data:{text}} = await Tesseract.recognize(canvas,'eng+kor',{
    logger: m=>{ /* console.log(m) */ }
  });
  return text;
}

function extractCandidates(text){
  // ëª¨ë¸/ë¶€í’ˆí˜•ì‹/ì˜ë¬¸-ìˆ«ì í† í° ìœ„ì£¼ ì¶”ì¶œ
  const set=new Set();
  const lines=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){
    if(/warranty|void|remove|broken|copyright|made in/i.test(ln)) continue;
    const m = ln.match(/[A-Z][A-Z0-9\-]{3,}|[A-Z]{2,}\d{2,}|[A-Z]\d[A-Z0-9\-]{2,}/gi);
    if(m){ m.forEach(x=>set.add(x)); }
  }
  return [...set].slice(0,12);
}

/* ---------- quick price heuristic (offline) ---------- */
function quickPrice(){
  const q=buildQuery().toLowerCase();
  let base=3000; // ê¸°ë³¸
  if(/ssd|nvme|m2|pcie/.test(q)) base=20000;
  if(/hdd|2tb|3tb|4tb/.test(q)) base=9000;
  if(/iphone|ipad|galaxy|watch/.test(q)) base=50000;
  if(/dell|hp|lenovo/.test(q)) base+=3000;
  const fast = Math.round(base*0.9/100)*100;  // ë¹¨ë¦¬íŒ”ê¸°
  const fair = Math.round(base*1.1/100)*100;  // ì œê°’
  $("#q").textContent=q||"(ë¹ˆê°’)";
  $("#p1").textContent=fast.toLocaleString('ko-KR')+"ì›";
  $("#p2").textContent=fair.toLocaleString('ko-KR')+"ì›";
}

/* ---------- post builders ---------- */
function titleFromCand(){
  const color=$("#color").value||"";
  const bc=$("#barcode").value||"";
  const words=($("#candidates").value||"")
    .split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,4);
  let t=words.join(" ");
  if(color) t = `${t} ${color}`.trim();
  if(!t && bc) t="ë°”ì½”ë“œ "+bc;
  return t || "ë¯¸ìƒ ì œí’ˆ";
}
function bodyKR(){
  const memo=$("#memo").value||"";
  const bc=$("#barcode").value||"-";
  const color=$("#color").value||"-";
  const cand=($("#candidates").value||"").split(/\n+/).filter(Boolean).slice(0,8).join(", ");
  return [
    `â€¢ ë°”ì½”ë“œ: ${bc}`,
    `â€¢ ìƒ‰ìƒ(ì¶”ì •): ${color}`,
    cand?`â€¢ í‚¤ì›Œë“œ: ${cand}`:null,
    memo?`â€¢ ìƒíƒœ/êµ¬ì„±: ${memo}`:`â€¢ ìƒíƒœ/êµ¬ì„±: ê¸°ë³¸ ì ê²€ ì™„ë£Œ`,
    `â€¢ ì§ê±°ë˜/íƒë°° ëª¨ë‘ ê°€ëŠ¥`
  ].filter(Boolean).join("\n");
}
function titleEN(){
  const base=titleFromCand().replace(/[ã„±-ã…ê°€-í£]/g," ").replace(/\s+/g," ").trim();
  return base||"Unknown Item";
}
function descEN(){
  const bc=$("#barcode").value||"";
  const color=$("#color").value||"";
  return `Condition: Used, tested OK
Barcode: ${bc}
Color (approx.): ${color}
Shipped carefully packed.`;
}

/* ---------- events ---------- */
$("#btnStart").onclick=startCamera;
$("#btnStop").onclick=stopCamera;

$("#btnSnap").onclick=async()=>{
  const f=$("#file").files?.[0];
  if(!f){ alert("ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
  const canvas=await drawFromFile(f);
  // ìƒ‰ìƒ ê°ì§€
  $("#color").value = averageColorFromCanvas(canvas);
  // ë°”ì½”ë“œ í•œ ë²ˆ ë” ì‹œë„(ì •ì§€í™”ë©´)
  try{
    const dataURL = canvas.toDataURL("image/png");
    Quagga.decodeSingle({
      src: dataURL,
      numOfWorkers: 0,
      inputStream: { size: 800 },
      decoder: { readers: ["ean_reader","ean_8_reader","code_128_reader","code_39_reader","upc_reader","upc_e_reader"] }
    }, (res)=>{
      if(res && res.codeResult){ $("#barcode").value=res.codeResult.code; }
    });
  }catch(e){}
};

$("#btnOCR").onclick=async()=>{
  const f=$("#file").files?.[0];
  const video=$("#video");
  let canvas=$("#canvas");
  if(f){
    canvas = await drawFromFile(f);
  }else if(video.srcObject){
    // ì¹´ë©”ë¼ í”„ë ˆì„ ìº¡ì³
    canvas.hidden=false;
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }else{
    alert("ì‚¬ì§„ ì—…ë¡œë“œ ë˜ëŠ” ì¹´ë©”ë¼ë¥¼ ì¼œì£¼ì„¸ìš”");
    return;
  }
  $("#color").value = averageColorFromCanvas(canvas);
  const text = await runOCR(canvas);
  appendCandidates(extractCandidates(text));
  quickPrice();
};

$("#btnSuggest").onclick=quickPrice;

$("#btnDanggeun").onclick=()=>{
  $("#krTitle").value = titleFromCand();
  $("#krBody").value  = bodyKR();
};
$("#btnNaver").onclick=()=>{
  $("#krTitle").value = "[íŒë§¤] " + titleFromCand();
  $("#krBody").value  = bodyKR()+"\n\nê°€ê²©ì€ ì‹œì„¸ ì°¸ê³ í•˜ì—¬ í˜‘ì˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
};
$("#btnEbay").onclick=()=>{
  $("#enTitle").value = titleEN();
  $("#enDesc").value  = descEN();
};
$("#btnCopyAll").onclick=async()=>{
  const txt = `ì œëª©: ${$("#krTitle").value}\n\n${$("#krBody").value}`;
  try{ await navigator.clipboard.writeText(txt); alert("ë³µì‚¬ ì™„ë£Œ"); }
  catch(e){ alert("ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ ë³µì‚¬í•˜ì„¸ìš”."); }
};

// UX: í´ë¦­ ì‹œ ì „ì²´ì„ íƒ
$$(".copy").forEach(el=>el.addEventListener("focus",e=>e.target.select()));
</script>
</body>
</html>
